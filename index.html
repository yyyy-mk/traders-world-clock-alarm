<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>â° íŠ¸ë ˆì´ë” ì„¸ê³„ì‹œê°„ ì•ŒëŒ (ì•ˆë“œë¡œì´ë“œ ì™„ë²½ ëŒ€ì‘)</title>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>
    <style>
        /* ìŠ¤íƒ€ì¼ ìƒëµ (ê¸°ì¡´ê³¼ ë™ì¼í•˜ê²Œ ìœ ì§€) */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(135deg, #434343 0%, #000000 100%); min-height: 100vh; padding: 20px; color: white; }
        .container { max-width: 800px; margin: 0 auto; }
        .card { background: rgba(255,255,255,0.1); border-radius: 15px; padding: 20px; margin-bottom: 20px; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
        .btn { padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 10px; }
        .btn-primary { background: #4e73df; color: white; }
        .notification-permission { background: #ff4757; padding: 15px; border-radius: 10px; margin-bottom: 20px; text-align: center; }
        input, select { width: 100%; padding: 10px; margin-top: 5px; border-radius: 5px; border: none; }
        .alarm-item { display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.05); padding: 10px; margin-top: 10px; border-radius: 8px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>â° World Alarm</h1>
        <div id="currentTime" style="font-size: 1.5em; margin: 20px 0; text-align: center;">ë¡œë”© ì¤‘...</div>

        <div id="permissionCard" class="notification-permission">
            âš ï¸ ì•ˆë“œë¡œì´ë“œ ì•Œë¦¼ì„ ìœ„í•´ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”!
            <button class="btn btn-primary" onclick="setupMobileMode()">ì•Œë¦¼ ë° ì›¨ì´í¬ë½ í™œì„±í™”</button>
        </div>

        <div class="card">
            <h3>ğŸ“ ì•ŒëŒ ì¶”ê°€</h3>
            <select id="tz"><option value="America/New_York">ë‰´ìš• (EST)</option><option value="Asia/Seoul" selected>ì„œìš¸ (KST)</option></select>
            <input type="time" id="time" value="22:30">
            <input type="text" id="name" placeholder="ì•ŒëŒ ì´ë¦„ (ì˜ˆ: ë¯¸ì¥ ê°œì¥)">
            <button class="btn btn-primary" onclick="addAlarm()">ì•ŒëŒ ì €ì¥</button>
        </div>

        <div class="card">
            <h3>ğŸ“‹ ëª©ë¡</h3>
            <div id="alarmList"></div>
        </div>
    </div>

    <script>
        const { DateTime } = luxon;
        let alarms = [];
        let wakeLock = null;

        // [1] ì„œë¹„ìŠ¤ ì›Œì»¤ ë“±ë¡ (ì•ˆë“œë¡œì´ë“œ ì•Œë¦¼ í•„ìˆ˜)
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js').then(() => {
                console.log('ì„œë¹„ìŠ¤ ì›Œì»¤ ë“±ë¡ ì™„ë£Œ');
            });
        }

        async function setupMobileMode() {
            // ì•Œë¦¼ ê¶Œí•œ ìš”ì²­
            const permission = await Notification.requestPermission();
            
            // ì˜¤ë””ì˜¤ ì ê¸ˆ í•´ì œ (ë¬´ìŒ ì¬ìƒ)
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (audioCtx.state === 'suspended') await audioCtx.resume();
            
            // ì›¨ì´í¬ë½ (í™”ë©´ ì¼œì§ ìœ ì§€)
            if ('wakeLock' in navigator) {
                try {
                    wakeLock = await navigator.wakeLock.request('screen');
                } catch (err) {}
            }
            
            if (permission === 'granted') {
                document.getElementById('permissionCard').style.display = 'none';
                alert('ì•ˆë“œë¡œì´ë“œ ëª¨ë“œ í™œì„±í™”! ë¸Œë¼ìš°ì €ë¥¼ ë„ì§€ ë§ˆì„¸ìš”.');
            }
        }

        function addAlarm() {
            const alarm = {
                id: Date.now(),
                tz: document.getElementById('tz').value,
                time: document.getElementById('time').value,
                name: document.getElementById('name').value || 'ì•ŒëŒ'
            };
            alarms.push(alarm);
            renderAlarms();
            localStorage.setItem('alarms', JSON.stringify(alarms));
        }

        function renderAlarms() {
            const list = document.getElementById('alarmList');
            list.innerHTML = alarms.map(a => `
                <div class="alarm-item">
                    <div><b>${a.name}</b> (${a.tz})<br>${a.time}</div>
                    <button onclick="deleteAlarm(${a.id})">âŒ</button>
                </div>
            `).join('');
        }

        function deleteAlarm(id) {
            alarms = alarms.filter(a => a.id !== id);
            renderAlarms();
            localStorage.setItem('alarms', JSON.stringify(alarms));
        }

        setInterval(() => {
            const now = DateTime.now();
            document.getElementById('currentTime').textContent = now.setZone('Asia/Seoul').toFormat('HH:mm:ss');

            alarms.forEach(alarm => {
                const alarmTime = DateTime.fromISO(alarm.time, { zone: alarm.tz });
                const nowInTz = now.setZone(alarm.tz);

                if (nowInTz.hour === alarmTime.hour && nowInTz.minute === alarmTime.minute && nowInTz.second === 0) {
                    triggerAlarm(alarm);
                }
            });
        }, 1000);

        function triggerAlarm(alarm) {
            // ì†Œë¦¬ ì¬ìƒ
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = audioCtx.createOscillator();
            osc.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + 1);

            // ì§„ë™
            if (navigator.vibrate) navigator.vibrate([500, 200, 500]);

            // [2] ì„œë¹„ìŠ¤ ì›Œì»¤ë¥¼ í†µí•œ ì•Œë¦¼ (ì•ˆë“œë¡œì´ë“œì—ì„œ ê°€ì¥ ì˜ ëœ¨ëŠ” ë°©ë²•)
            if (Notification.permission === 'granted') {
                navigator.serviceWorker.ready.then(registration => {
                    registration.showNotification('â° ' + alarm.name, {
                        body: `${alarm.tz} ê¸°ì¤€ ${alarm.time}ì…ë‹ˆë‹¤.`,
                        icon: 'https://cdn-icons-png.flaticon.com/512/182/182321.png',
                        vibrate: [200, 100, 200],
                        tag: 'trading-alarm'
                    });
                });
            }
            
            alert(`â° ì•ŒëŒ: ${alarm.name}`);
        }

        window.onload = () => {
            const saved = localStorage.getItem('alarms');
            if (saved) alarms = JSON.parse(saved);
            renderAlarms();
        };
    </script>
</body>
</html>
